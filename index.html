<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecionamento - Contador</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: Arial, sans-serif;
        }
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
            display: none; /* Escondido por padr√£o */
        }
        .debug-visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Debug vis√≠vel durante desenvolvimento -->
    <div id="debug">
        <strong>Debug - Contador de Cliques</strong><br>
        <span id="status">Iniciando...</span>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURA√á√ïES - SUBSTITUA PELOS SEUS DADOS ‚ö†Ô∏è
        const CONFIG = {
            // Cole sua API Key do JSONBin aqui:
            API_KEY: '$2a$10$f7XvB6OBfqgX4W29YTo1Yu7GTSNc1JcpMrU7znVJwOBPXrUuAleji', 
            
            // Cole o ID do seu Bin aqui:
            BIN_ID: '6894ea36203a8b52b5e1046b', 
            
            // Site para onde redirecionar ap√≥s registrar o clique:
            REDIRECT_URL: 'https://www.google.com/', 
            
            // Tempo em ms para aguardar antes de redirecionar (para debug)
            REDIRECT_DELAY: 0, // Redireciona imediatamente
            
            // Modo debug (true = mostra mensagens, false = invis√≠vel)
            DEBUG_MODE: false
        };

        // Fun√ß√£o CORRIGIDA para hor√°rio de Bras√≠lia (UTC-3)
        function getUTC3DateTime() {
            // Obt√©m a data/hora atual em UTC
            const agora = new Date();
            
            // Converte para hor√°rio de Bras√≠lia de forma confi√°vel
            const brasiliaTime = new Date(agora.toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            
            // Formata a data e hora no padr√£o brasileiro
            const data = brasiliaTime.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const hora = brasiliaTime.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // Cria um timestamp que preserva o hor√°rio de Bras√≠lia
            // Salvamos a data/hora de Bras√≠lia como timestamp UTC
            const timestamp = brasiliaTime.getTime();
            
            return {
                timestamp: timestamp,  // Timestamp da hora de Bras√≠lia
                data: data,           // DD/MM/YYYY
                hora: hora,           // HH:MM:SS
                iso: brasiliaTime.toISOString() // ISO string da hora de Bras√≠lia
            };
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            console.log(message);
        }

        function showDebug() {
            if (CONFIG.DEBUG_MODE) {
                document.getElementById('debug').classList.add('debug-visible');
            }
        }

        async function obterIP() {
            try {
                updateStatus('üåê Obtendo IP...');
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                updateStatus(`üìç IP: ${data.ip}`);
                return data.ip;
            } catch (error) {
                updateStatus(`‚ùå Erro no IP: ${error.message}`);
                return 'Desconhecido';
            }
        }

        async function obterLocalizacao(ip) {
            try {
                updateStatus('üó∫Ô∏è Obtendo localiza√ß√£o...');
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await response.json();
                const loc = `${data.city || 'N/A'}, ${data.country_name || 'N/A'}`;
                updateStatus(`üåç Local: ${loc}`);
                return loc;
            } catch (error) {
                updateStatus(`‚ö†Ô∏è Erro localiza√ß√£o: ${error.message}`);
                return 'Desconhecida';
            }
        }

        async function obterDadosClique() {
            updateStatus('üìä Coletando dados...');
            
            const ip = await obterIP();
            const localizacao = await obterLocalizacao(ip);
            const dateTime = getUTC3DateTime();

            // Detecta tipo de dispositivo
            const userAgent = navigator.userAgent;
            let dispositivo = 'Desktop';
            
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
                dispositivo = 'Mobile';
            } else if (/Tablet|iPad/i.test(userAgent)) {
                dispositivo = 'Tablet';
            }

            const dados = {
                ip: ip,
                timestamp: dateTime.timestamp,  // Timestamp correto
                data: dateTime.data,
                hora: dateTime.hora,
                localizacao: localizacao,
                dispositivo: dispositivo,
                navegador: getBrowser(userAgent),
                sistemaOperacional: getOS(userAgent),
                urlOrigem: window.location.href
            };

            updateStatus(`‚úÖ Dados coletados! Hora: ${dateTime.data} ${dateTime.hora}`);
            return dados;
        }

        function getBrowser(userAgent) {
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edg')) return 'Edge';
            return 'Outro';
        }

        function getOS(userAgent) {
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac')) return 'macOS';
            if (userAgent.includes('Linux')) return 'Linux';
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('iPhone') || userAgent.includes('iPad')) return 'iOS';
            return 'Outro';
        }

        async function salvarClique(dadosClique) {
            try {
                updateStatus('üì• Buscando dados existentes...');
                
                // Primeiro, busca os dados existentes
                const getResponse = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': CONFIG.API_KEY
                    }
                });

                let cliquesExistentes = [];
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    cliquesExistentes = data.record.cliques || [];
                    updateStatus(`üìã ${cliquesExistentes.length} cliques existentes`);
                } else {
                    throw new Error(`Erro GET: ${getResponse.status} ${getResponse.statusText}`);
                }

                // Adiciona o novo clique
                cliquesExistentes.push(dadosClique);
                updateStatus(`‚ûï Adicionando clique... Total: ${cliquesExistentes.length}`);

                // Salva de volta
                updateStatus('üíæ Salvando...');
                const putResponse = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        cliques: cliquesExistentes
                    })
                });

                if (putResponse.ok) {
                    updateStatus('‚úÖ Clique salvo com sucesso!');
                    return true;
                } else {
                    throw new Error(`Erro PUT: ${putResponse.status} ${putResponse.statusText}`);
                }

            } catch (error) {
                updateStatus(`‚ùå Erro ao salvar: ${error.message}`);
                console.error('Erro completo:', error);
                return false;
            }
        }

        async function iniciar() {
            try {
                showDebug();
                updateStatus('üöÄ Iniciando contador...');
                
                // Valida√ß√£o b√°sica
                if (!CONFIG.API_KEY || !CONFIG.BIN_ID) {
                    throw new Error('API_KEY ou BIN_ID n√£o configurados!');
                }

                // Coleta dados do clique
                const dadosClique = await obterDadosClique();
                console.log('Dados do clique:', dadosClique);
                
                // Salva o clique
                const sucesso = await salvarClique(dadosClique);
                
                if (sucesso) {
                    updateStatus(`üéâ Sucesso! Redirecionando em ${CONFIG.REDIRECT_DELAY/1000}s...`);
                } else {
                    updateStatus(`‚ö†Ô∏è Erro no salvamento. Redirecionando em ${CONFIG.REDIRECT_DELAY/1000}s...`);
                }
                
                // Redireciona ap√≥s o delay
                setTimeout(() => {
                    window.location.href = CONFIG.REDIRECT_URL;
                }, CONFIG.REDIRECT_DELAY);

            } catch (error) {
                updateStatus(`üí• Erro cr√≠tico: ${error.message}`);
                console.error('Erro cr√≠tico:', error);
                
                // Mesmo com erro, redireciona ap√≥s um tempo
                setTimeout(() => {
                    window.location.href = CONFIG.REDIRECT_URL;
                }, CONFIG.REDIRECT_DELAY);
            }
        }

        // Inicia quando a p√°gina carrega
        window.onload = iniciar;

        // Para debug: permite cancelar redirecionamento
        if (CONFIG.DEBUG_MODE) {
            window.cancelRedirect = function() {
                updateStatus('üõë Redirecionamento cancelado para debug');
            };
        }
    </script>
</body>
</html>
